function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null==c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function sanitizeCountry(a){var b=a.toLowerCase();return b=b.replace(new RegExp("\\s","g"),"-"),b=b.replace(new RegExp("[àáâãäå]","g"),"a"),b=b.replace(new RegExp("æ","g"),"ae"),b=b.replace(new RegExp("ç","g"),"c"),b=b.replace(new RegExp("[èéêë]","g"),"e"),b=b.replace(new RegExp("[ìíîï]","g"),"i"),b=b.replace(new RegExp("ñ","g"),"n"),b=b.replace(new RegExp("[òóôõö]","g"),"o"),b=b.replace(new RegExp("œ","g"),"oe"),b=b.replace(new RegExp("[ùúûü]","g"),"u"),b=b.replace(new RegExp("[ýÿ]","g"),"y"),b=b.replace(new RegExp("\\W","g"),"-"),b=b.replace(new RegExp("'","g"),"-")}function torque_(a){function b(){}return b.reach=function(b){function c(a,b){function c(a){return 10>a?"0"+a:a}a=a.getTime?a.getTime():a,b=b.getTime?b.getTime():b;var d=(b-a)/1e3,e=86400,f=31*e*12;return e>d?function(a){return c(a.getUTCHours())+":"+c(a.getUTCMinutes())}:f>d?function(a){return c(a.getUTCMonth()+1)+"/"+c(a.getUTCDate())+"/"+c(a.getUTCFullYear())}:function(a){return c(a.getUTCMonth()+1)+"/"+c(a.getUTCFullYear())}}function d(b){var d=a.getTimeBounds();if(d){if("date"!==d.columnType)return b;if(d&&void 0!==d.start){var e=c(d.start,d.end);if(!_.isNaN(a.stepToTime(b).getYear()))return e(a.stepToTime(b))}}}function e(a){0===a.step&&($(".Scoreboard-number").removeClass("is-visible"),$(".Scoreboard-number--0").addClass("is-visible"));var b=100*a.step/1440;$(".progress").width(b+"%"),a.step>=f-5&&a.step<f+5?(g.trigger(),v&&!v.is(":visible")&&v.show().animate({marginRight:0,opacity:1},150),z&&!z.is(":visible")&&(z.siblings(".Scoreboard-number").removeClass("is-visible"),z.addClass("is-visible"))):a.step>=f+5&&a.step<f+10&&setTimeout(function(){v&&v.animate({marginRight:-30,opacity:0},150,function(){$(this).appendTo($(".Notifications > ul")),$(this).hide()})},6e3)}var f=b.get("step").value;TIME||($(".Footer-time--l").text(d(0)),$(".Footer-time--r").text(d(a.options.steps)),TIME=!0);var g=O.Trigger({}),h=b.html().split("<h1>")[1].split("</h1>")[0],i=h.split("+")[0],j=h.split("+")[1],k="true"===h.split("+")[2],l=h.split("+")[3],m=h.split("+")[4],n=b.html().split("<h2>")[1].split("</h2>")[0],o=decodeURIComponent(n.split("+")[0]),p="null"!=o&&""!=o?"background: url("+o+") no-repeat center;":"",q=decodeURIComponent(n.split("+")[1]),r=b.html().split("</h2>")[1];if(k){var s=f*$("#map .slider").width()/a.options.steps,t=['<div class="slide-tip slide-tip-s'+f+("null"!=j&&""!=j?" slide-tip-t"+j:"")+" slide-tip-n"+i+'" style="left:'+s+"px;"+("score"===i?p:"")+'" data-steps="'+f+'">','<div class="tooltip">',"<h2>"+d(f)+"</h2>"+(q?"<p>"+q+"</p>":""),"</div>","</div>"].join("\n");$("#map .slider").append(t)}if("slide"===i){var u=['<li class="Notification Notification_'+f+'">','<div class="Notification-text">','<p class="Notification-time">'+d(f)+"</p>",'<div class="Notification-content">'+(m?"<h2>"+m+"</h2>":""),"<p>"+r+"</p>","</div>","</li>"].join("\n");$(".Notifications > ul").append(u);var v=$(".Notification_"+f)}if("score"===i){var w=$(".Scoreboard-team--"+j+" .Scoreboard-number").last(),x=parseInt(w.text(),10),y='<p class="Scoreboard-number Scoreboard-number--'+(x+1)+" Scoreboard-number_"+f+'">'+l+"</p>";$(".Scoreboard-team--"+j+" .Scoreboard-count").append(y);var z=$(".Scoreboard-number_"+f)}var A=$("#map .slider-wrapper");$(".slide-tip-s"+f).on("mouseenter",function(){var a=$(this).find(".tooltip").clone();A.append(a.css({left:$(this).css("left"),top:$(this).css("top")})),a.fadeIn(250)}).on("mouseleave",function(){A.children(".tooltip").fadeOut(250,function(){$(this).remove()})});var B=$(".slide-tip-s"+f+" .tip"),C=($(".slide-tip-s"+f+" .tooltip"),B.width()/2);return B.css({margin:-C}),a.on("change:time",e),g.clear=function(){a.off("change:time",e)},g},b.pause=function(){return O.Action(function(){a.pause()})},b.play=function(){return O.Action(function(){a.play()})},b}var VIZJSON=getParameterByName("vis"),VIZJSON_URL,TITLE,DESCRIPTION,DURATION,LAT=getParameterByName("center").split(",")[0],LNG=getParameterByName("center").split(",")[1],ZOOM=getParameterByName("center").split(",")[2],USER=getParameterByName("utn").split(",")[0],TABLE_NAME=getParameterByName("utn").split(",")[1],TEAM1=_.escape(getParameterByName("t").split("|")[0].split(",")[0]),TEAM1_COLOR="#"+_.escape(getParameterByName("t").split("|")[0].split(",")[1]),TEAM1_SANITIZED=sanitizeCountry(TEAM1),TEAM2=_.escape(getParameterByName("t").split("|")[1].split(",")[0]),TEAM2_COLOR="#"+_.escape(getParameterByName("t").split("|")[1].split(",")[1]),TEAM2_SANITIZED=sanitizeCountry(TEAM2),TIME=!1;O.Template({init:function(){var a=this;if(USER&&VIZJSON){VIZJSON_URL="http://"+USER+".cartodb.com/api/v2/viz/"+VIZJSON+"/viz.json";var b=["```",'-title: "'+TITLE+'"','-author: "author"','-vizjson: "'+VIZJSON_URL+'"',"-duration: "+DURATION||30,"```","\n"].join("\n"),c=new cartodb.SQL({user:USER});c.execute("SELECT * FROM "+TABLE_NAME+" ORDER BY date ASC").done(function(c){var d=c.rows;cartodb.createVis("map","http://srogers.cartodb.com/api/v2/viz/bdd137fe-a60d-11e4-a7d7-0e4fddd5de28/viz.json").done(function(b){var c=a.map=b.getNativeMap();""!==getParameterByName("center")&&c.setView([LAT,LNG],ZOOM),cdb.vis.Loader.get(VIZJSON_URL,function(b){for(var d=0;d<b.layers.length;++d)"torque"===b.layers[d].type&&cartodb.createLayer(c,b,{layerIndex:d}).done(function(b){a.torqueLayer=b,c.addLayer(a.torqueLayer)})})});var e=!1;setInterval(function(){function c(a,b,c,d){return d*(a-b)/(c-b)}if(a.torqueLayer&&a.torqueLayer.getTimeBounds().start&&a.torqueLayer.getTimeBounds().end&&e===!1){for(var f=0;f<d.length;++f){var g=d[f],h=c(new Date(d[f].date).getTime(),a.torqueLayer.getTimeBounds().start,a.torqueLayer.getTimeBounds().end,a.torqueLayer.options.steps),i=["#"+g.event_type+"+"+g.team_id+"+"+g.visible+"+"+g.score_panel+"+"+g.slide_panel_title,"```\n-step: "+parseInt(h,10)+"\n"+(g.odyssey_actions?g.odyssey_actions+"\n":"")+"```","##"+encodeURIComponent(g.event_icon_url)+"+"+encodeURIComponent(g.tooltip_title),g.slide_panel_content_md].join("\n");b=b+"\n\n"+i}a.update(actionsFromMarkdown(b.replace(/"/g,"'"))),e=!0}},1),$(".Scoreboard-team--1 .team-marker").css({background:TEAM1_COLOR}),$(".Scoreboard-team--2 .team-marker").css({background:TEAM2_COLOR}),$(".Scoreboard-team--1 .Scoreboard-title").text(TEAM1),$(".Scoreboard-team--2 .Scoreboard-title").text(TEAM2)})}},_initActions:function(a){for(var b=0;b<a.length;++b){var c=a[b],d=O.Parallel(O.Actions.CSS($(".Notifications")).addClass("is-visible"),this.slides.activate(b),c(this));if(!c.get("step"))return;this.story.addState(torque_(this.torqueLayer).reach(c),d)}},_reposition:function(){var a=this;_.each($("#map .slide-tip"),function(b){var c=$(b).data("steps")*$("#map .slider").width()/a.torqueLayer.options.steps;$(b).css("left",c)})},update:function(a){var b=this;cdb.vis.Loader.get(VIZJSON_URL,function(c){TITLE=c.title,DESCRIPTION=c.description,document.title=TITLE,$("meta[name=description]").attr("content",DESCRIPTION),$(".Footer-infoTitle").text(TITLE);b.slides=O.Actions.Slides("slides"),b.story=O.Story();b.torqueLayer.play(),b.torqueLayer.actions=torque_(b.torqueLayer),b._initActions(a);var d;$(window).on("resize",function(){null!=d&&clearTimeout(d),d=setTimeout(function(){b._reposition()},400)})})}});